<!DOCTYPE HTML>

<html>
   <head>
      <title>Circular Snake</title>

      <link href='http://fonts.googleapis.com/css?family=Oswald:700' rel='stylesheet' type='text/css'>

      <style>
			body {
				background-color: #202020;
				height: 100%;
				width: 100%;
				background-attachment: fixed;
			}

			#canvas:-webkit-full-screen { background-color: rgba(255,255,255,0); }

			#canvas {
				margin: auto; position: absolute;
				top: 0; bottom: 0; right: 0; left: 0;
			}
      </style>

      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

      <script>
         // PARAMETERS

         //////////////////////////
			// Graphics parameters  //
			//////////////////////////

         //Radius factor: field radius = canvas.height * radiusFactor
			var radiusFactor = 0.40;

         // Radius of snake points
         var snakePointRadius = 9;

         //Field color: the background color of the circular game field
			var fieldColor = "#303030";

         // Fruit color
         var fruitColor = "#FCFFA3";

         //Width of the screen shake effect
			var screenshakeWidth = 3;

         // Score text color
         var scoreColor = "#FCFFA3";

         // Score text size
         var scoreSize = 96;

         //////////////////////////
			// Game parameters      //
			//////////////////////////

         var fruitRadius = snakePointRadius;

         // Snake base speed, in pixels per second
         var snakeBaseSpeed = 100;

          // Snake curve radius, in pixels
         var snakeRotateRadius = 40;

         // Rotation speed, in radians per second
         var snakeRotateSpeed = snakeBaseSpeed / snakeRotateRadius;

         // Length gained for each fruit
         var fruitLength = 20;

         // Snake initial length, in snake points
         var snakeInitialLength = 150;
      </script>

      <script>
         var canvas = 0, context = 0;
         var fps = 60;

         var radius = 0;

         var dist = function ( a, b ) {
            var dx = a[0] - b[0];
            var dy = a[1] - b[1];
            return Math.sqrt ( dx*dx + dy*dy );
         }

         var dist2 = function ( a, b ) {
            var dx = a[0] - b[0];
            var dy = a[1] - b[1];
            return dx*dx + dy*dy;
         }

         var Snake = function () {
            // Color of the snake
            this.color = "#FF6000";

            // Array of the positions of the extremes of the segments of the
            // snake; it is an array of arrays of two elements each, x and y
            // coordinates of the point, relative to the center of the field
            this.positions = [ ];

            // Snake direction : defined as an angle in radians from PI to -PI
            this.direction = 0;
            this.rotate = -1;

            // Snake base speed, in pixels per second
            this.speed = snakeBaseSpeed;

            // Function that moves the snake for the requested time step
            this.move = function ( t ) {
               var dx = this.speed * t;

               for ( var i = this.positions.length - 1; i > 0; --i ) {
                  this.positions[i] = this.positions[i-1].slice(0);
                  this.positions[i][2] = 0.01 * snakePointRadius + 0.99 * this.positions[i][2];
               }

               this.positions[0][0] += dx * Math.cos ( this.direction );
               this.positions[0][1] += dx * Math.sin ( this.direction );
               this.positions[0][2] = snakePointRadius;

               this.direction += snakeRotateSpeed * this.rotate * t;
            }

            // Function that grows the snake by one element
            this.grow = function ( k ) {
               for ( var i = 0; i < k; ++i ) {
                  this.positions.push(this.positions[this.positions.length-1].slice(0));
               }
            }

            // Plays eat animation effect
            this.eat = function () {
               this.grow ( fruitLength );
               this.positions[0][2] = snakePointRadius * 1.8;
            }

            // Function that draws the snake on a graphic context
            this.draw = function ( context ) {
               context.fillStyle = this.color;

               for ( var i = 0; i < this.positions.length; i++ ) {
                  context.beginPath ();
                  context.arc ( this.positions[i][0], this.positions[i][1], this.positions[i][2], 0, 2*Math.PI );
                  context.fill ();
               }

               context.fillStyle = fieldColor;
               context.beginPath ();
               context.arc ( this.positions[0][0], this.positions[0][1], this.positions[0][2]*0.6, 0, 2*Math.PI );
               context.fill();
            }
         }

         var Match = function ( ) {
            // Game running flag
            this.running = false;

            // Match snake
            this.snake = new Snake ( );

            // Current fruit position
            // Coordinates relative to field center
            this.fruit = [0,0];

            // Score
            this.score = 0;

            // Function that sets up the game
            this.setup = function ( ) {
               this.snake = new Snake ( );
               this.snake.positions.push ( [0,snakeRotateRadius/2+snakePointRadius/2,snakePointRadius] );
               this.snake.grow ( snakeInitialLength );
               this.spawnFruit ( );
               this.running = true;
            }

            // Function that draws the game
            this.draw = function ( context ) {
               this.snake.draw ( context );

               context.fillStyle = fruitColor;
               context.beginPath();
               context.arc ( this.fruit[0], this.fruit[1], fruitRadius, 0, 2*Math.PI );
               context.fill();
            }

            // Function that updates the game
            this.update = function ( t ) {
               if ( !this.running ) return;

               var oldPositions = [];
               for ( var i = 0; i < this.snake.positions.length; ++i )
                  oldPositions.push ( this.snake.positions[i].slice(0) );
               this.snake.move ( t );

               // Check if the snake has hit the fruit
               var r = fruitRadius + snakePointRadius;
               if ( dist2 ( this.snake.positions[0], this.fruit ) < r*r ) {
                  this.score++;
                  this.spawnFruit();

                  this.snake.eat();

                  shake();
               }

               // Check if the snake has hit the border or itself
               r = radius - snakePointRadius;
               if ( dist2 ( this.snake.positions[0], [0,0] ) > r*r )
                  this.running = false;

               // Check if the snake has hit some parts of itself
               r = 2*snakePointRadius;
               for ( var i = 11; i < this.snake.positions.length; ++i )
                  if ( dist2 ( this.snake.positions[0], this.snake.positions[i] ) < r*r &&
                       dist2 ( oldPositions[0], oldPositions[i] ) >= r*r )
                     this.running = false;
            }

            // Spawns a fruit in the game
            this.spawnFruit = function () {
               var r = Math.random() * (radius - fruitRadius - 5);
               var th = Math.random() * 2*Math.PI;

               this.fruit[0] = r * Math.cos(th);
               this.fruit[1] = r * Math.sin(th);
            }
         }

         var match = new Match ();

         var screenshake = 0;
			var screenshakeBegin = -1;
         var shake = function () { screenshakeBegin = Date.now(); }

         var keys = new Array();
			var registerKey = function ( n, k ) { keys.push ( { name: n, key: k, state: undefined } ); };

			var key = function ( name ) {
				var result = 0;
				for ( i = 0; i < keys.length; i++ )
					if ( keys[i].name == name ) result = result || keys[i].state;
				return result;
			}

			document.onkeydown = function ( e ) {
				for ( var i = 0; i < keys.length; i++ )
					if ( e.which == keys[i].key ) keys[i].state = 1;
			}

			document.onkeyup = function ( e ) {
				for ( var i = 0; i < keys.length; i++ )
					if ( e.which == keys[i].key ) keys[i].state = 0;
			}

         var setup = function ( ) {
            canvas = document.getElementById ( "canvas" );
            context = canvas.getContext ( "2d" );

            radius = Math.max ( canvas.width, canvas.height ) * radiusFactor;

            setInterval ( draw, 1000 / fps );
            setInterval ( update, 1000 / fps );

            bgColor = $("body").css("background-color");

            match.setup ();

            document.onkeypress = function ( e ) {
               if ( e.which == 32 ) match.snake.rotate *= -1;
            }

            document.onclick = function ( e ) { match.snake.rotate *= -1; }
         }

         var draw = function ( ) {
            context.save ( );
            context.translate ( screenshake, 0 );

				context.fillStyle = bgColor;
				context.fillRect ( 0, 0, canvas.width, canvas.height );

            context.translate ( canvas.width / 2, canvas.height / 2 );

				context.fillStyle = fieldColor;
				context.beginPath();
				context.arc ( 0, 0, radius, 0, 2 * Math.PI );
				context.fill();

            match.draw ( context );

            context.restore ( );

            context.fillStyle = scoreColor;
				context.font = scoreSize + "px Oswald";
				context.textAlign = "start";
				context.fillText ( match.score, 10, 10 + scoreSize );
         }

         var update = function ( ) {
            match.update ( 1 / fps );

            if ( screenshakeBegin > 0 ) {
					var t = Date.now() - screenshakeBegin;
					screenshake = screenshakeWidth * Math.exp(- t / 150 ) * ( Math.sin(t/30) + Math.cos(t/30) );
				}
         }
      </script>
   </head>

   <body onload="setup()">
   		<canvas width="600" height="600" id="canvas"></canvas>
   </body>
</html>
